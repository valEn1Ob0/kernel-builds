name: Kernel Builds

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 1 * *"   # mensual

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    # ========================
    # INSTALL DEPENDENCIES
    # ========================
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential flex bison dwarves bc \
          libssl-dev libelf-dev libncurses-dev \
          wget curl jq

    # ========================
    # BUILD CACHE
    # ========================
    - name: Setup ccache
      uses: actions/cache@v3
      with:
        path: ~/.cache/ccache
        key: ${{ runner.os }}-ccache-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-ccache-

    # ========================
    # MAKE SCRIPTS EXECUTABLE
    # ========================
    - name: Make scripts executable
      run: chmod +x scripts/*.sh

    # ========================
    # FETCH SOURCE
    # ========================
    - name: Fetch latest kernel
      run: |
        mkdir build
        cd build
        ../scripts/fetch-latest.sh mainline

    - name: Load version
      working-directory: build
      run: echo "KVER=$(cat latest.txt)" >> $GITHUB_ENV

    # ========================
    # PACK SOURCE (still needed)
    # ========================
    - name: Pack source
      working-directory: build
      run: ../scripts/package-source.sh

    # ========================
    # BUILD DEFCONFIG
    # ========================
    - name: Build defconfig kernel
      working-directory: build/kernel-source
      run: |
        make defconfig
        make -j"$(nproc)"
        mkdir -p ../../artifacts/defconfig
        cp -v vmlinux .config System.map arch/x86_64/boot/bzImage ../../artifacts/defconfig/

    # ========================
    # PREPARE DEBUG CONFIG
    # ========================
    - name: Prepare debug config
      working-directory: build/kernel-source
      run: |
        scripts/config --file .config \
          -e DEBUG_KERNEL \
          -e DEBUG_INFO \
          -e GDB_SCRIPTS \
          -e KALLSYMS_ALL \
          -e DEBUG_INFO_DWARF_TOOLCHAIN_DEFAULT
          
    # ========================
    # BUILD DEBUG KERNEL
    # ========================
    - name: Build debug kernel
      working-directory: build/kernel-source
      run: |
        make -j"$(nproc)"
        make scripts_gdb
    
        mkdir -p ../../artifacts/debug
    
        cp -a . ../../artifacts/debug/

    # ========================
    # UPLOAD ARTIFACTS
    # ========================
    - name: Upload defconfig
      uses: actions/upload-artifact@v4
      with:
        name: kernel-defconfig-${{ env.KVER }}
        path: artifacts/defconfig

    - name: Upload debug
      uses: actions/upload-artifact@v4
      with:
        name: kernel-debug-${{ env.KVER }}
        path: artifacts/debug
